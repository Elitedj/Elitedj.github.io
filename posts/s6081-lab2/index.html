<!doctype html><html lang=zh dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MIT6.S081 System Calls | Elitedj's Blog</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<link rel=stylesheet href=/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=/js/fontawesome.min.a975d08212c5439f29e6074e7ad58e159ae1ef5efb6a31962fa3b6885557e794dd9315f4a8a16d705066d023f4eaaf07.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=/images/avatar_hubecf9d80b8b876872272a68886c75e90_327995_32x32_fill_box_center_3.png><link rel=apple-touch-icon sizes=180x180 href=/images/avatar_hubecf9d80b8b876872272a68886c75e90_327995_180x180_fill_box_center_3.png><meta name=description content="MIT 6.S081 Fall 2020 Lab System Calls"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"MIT6.S081 System Calls","item":"/posts/s6081-lab2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/s6081-lab2/"},"headline":"MIT6.S081 System Calls | Elitedj\u0027s Blog","datePublished":"2021-09-22T23:33:21+00:00","dateModified":"2021-09-22T23:33:21+00:00","wordCount":1336,"publisher":{"@type":"Person","name":"Elitedj","logo":{"@type":"ImageObject","url":"/images/avatar.png"}},"description":"MIT 6.S081 Fall 2020 Lab System Calls"}</script><meta property="og:title" content="MIT6.S081 System Calls | Elitedj's Blog"><meta property="og:type" content="article"><meta property="og:image" content="/images/avatar.png"><meta property="og:url" content="/posts/s6081-lab2/"><meta property="og:description" content="MIT 6.S081 Fall 2020 Lab System Calls"><meta property="og:locale" content="zh"><meta property="og:site_name" content="Elitedj's Blog"><meta property="article:published_time" content="2021-09-22T23:33:21+00:00"><meta property="article:modified_time" content="2021-09-22T23:33:21+00:00"><meta property="article:section" content="posts"><meta property="article:tag" content="MIT"><meta property="article:tag" content="6.S081"><meta property="article:tag" content="OS"><meta property="og:see_also" content="/posts/start-xv6/"><meta property="og:see_also" content="/posts/s6081-lab1/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Elitedj's Blog</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/about class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">About</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>浅色</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>深色</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>自动</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>MIT6.S081 System Calls</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2021-09-22</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>3分钟阅读时长</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=/categories/6.s081/ class=hover:text-eureka>6.S081</a></div><div class="me-6 my-2"><i class="fas fa-th-list me-1"></i>
<a href=/series/mit-s6.081/ class=hover:text-eureka>MIT S6.081</a></div></div><h1 id=lab-system-calls>Lab: System Calls</h1><h2 id=system-call-tracing>System call tracing</h2><blockquote><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You&rsquo;ll create a new trace system call that will control tracing. It should take one argument, an integer &ldquo;mask&rdquo;, whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls trace(1 &#171; SYS_fork), where SYS_fork is a syscall number from kernel/syscall.h. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call&rsquo;s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don&rsquo;t need to print the system call arguments. The trace system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p></blockquote><p>需要自己实现一个叫trace的syscall，在user/trace.c中有调用trace的源码，而我们的目的就是让这一段代码能够跑通，并且输出我们希望打印的系统调用函数的结果。</p><p>trace接受一个整数参数trace_mask，通过二进制位的标记来输出系统调用的结果。例如trace 32，表示输出read函数的调用结果，因为(1 &#171; SYS_read)是32，输出形式如下：<code>pid: syscall read → ret</code>。</p><h3 id=注册用户程序trace>注册用户程序trace</h3><p>首先想要调用user/trace.c，需要在Makefile的UPROGS下添加$U/_trace。</p><h3 id=添加系统调用trace函数原型>添加系统调用trace函数原型</h3><p>在user/user.h中添加函数原型。</p><pre><code class=language-c>//sys_call
int fork(void);
...
int update(int);
int trace(int);
</code></pre><h3 id=添加ecall入口>添加ecall入口</h3><p>在user/usys.pl中添加ecall调用trace的入口</p><pre><code class=language-c>...
entry(&quot;update&quot;);
entry(&quot;trace&quot;);
</code></pre><h3 id=设置系统调用的序号>设置系统调用的序号</h3><p>在kernel/syscall.h中定义trace函数的序号</p><pre><code class=language-c>...
#define SYS_close 21
#define SYS_trace 22
</code></pre><h3 id=为进程添加trace_mask参数>为进程添加trace_mask参数</h3><p>需要记录下传入的trace_mask参数我们才知道当前进程执行的系统调用是否需要输出信息。所以需要在kernel/proc.h中修改proc结构体，增加trace_mask</p><pre><code class=language-c>struct proc {
	...
	int trace_mask;  // for trace
};
</code></pre><h3 id=实现sys_trace>实现sys_trace()</h3><p>定义完了就需要实现函数，在kernel/sysproc.c中实现我们的系统调用，需要从当前进程中取得传入的trace_mask标记。</p><pre><code class=language-c>uint64
sys_trace(void)
{
    int trace_mask;
    argint(0, &amp;trace_mask);
    if (trace_mask &lt; 0)
        return -1;

    struct proc *p = myproc();
    p-&gt;trace_mask = trace_mask;

    return 0;
}
</code></pre><h3 id=修改fork>修改fork()</h3><p>调用kernel/proc.c的fork()函数时，我们需要将父进程的track_mask传给子进程。</p><pre><code class=language-c>...
np-&gt;trace_mask = p-&gt;trace_mask;

release(&amp;np-&gt;lock);

return pid;
</code></pre><h3 id=修改syscall>修改syscall()</h3><p>只有在调用syscall()时才知道到底要不要输出调用信息，已经输出调用结果。</p><pre><code class=language-c>// kernel/syscall.c

...
extern uint64 sys_trace(void);

static uint64 (*syscalls[])(void) = {
	...
	[SYS_trace] sys_trace,
};

static char *syscall_name[] = {
    &quot;fork&quot;,
    &quot;exit&quot;,
    &quot;wait&quot;,
    &quot;pipe&quot;,
    &quot;read&quot;,
    &quot;kill&quot;,
    &quot;exec&quot;,
    &quot;fstat&quot;,
    &quot;chdir&quot;,
    &quot;dup&quot;,
    &quot;getpid&quot;,
    &quot;sbrk&quot;,
    &quot;sleep&quot;,
    &quot;uptime&quot;,
    &quot;open&quot;,
    &quot;write&quot;,
    &quot;open&quot;,
    &quot;mknod&quot;,
    &quot;unlink&quot;,
    &quot;link&quot;,
    &quot;mkdir&quot;,
    &quot;close&quot;,
    &quot;trace&quot;,
};

void
syscall(void)
{
  int num;
  struct proc *p = myproc();

  num = p-&gt;trapframe-&gt;a7;
  if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) {
    p-&gt;trapframe-&gt;a0 = syscalls[num]();
    // trace output
    if ((1 &lt;&lt; num) &amp; p-&gt;trace_mask)
        printf(&quot;%d: syscall %s -&gt; %d\\n&quot;, p-&gt;pid, syscall_name[num - 1], p-&gt;trapframe-&gt;a0);
  } else {
    printf(&quot;%d %s: unknown sys call %d\\n&quot;,
            p-&gt;pid, p-&gt;name, num);
    p-&gt;trapframe-&gt;a0 = -1;
  }
}
</code></pre><h2 id=sysinfo>Sysinfo</h2><blockquote><p>In this assignment you will add a system call, sysinfo, that collects information about the running system. The system call takes one argument: a pointer to a struct sysinfo (see kernel/sysinfo.h). The kernel should fill out the fields of this struct: the freemem field should be set to the number of bytes of free memory, and the nproc field should be set to the number of processes whose state is not UNUSED. We provide a test program sysinfotest; you pass this assignment if it prints &ldquo;sysinfotest: OK&rdquo;.</p></blockquote><p>做一个简单的sysinfo系统调用，输出简单的信息。</p><p>整体步骤和上面的差不多，只是需要自己实现两个统计的函数即可。</p><h3 id=nfreemem>nfreemem()</h3><p>在kernel/kalloc.c中添加统计可用的内存字节数的函数nfreemem()。</p><pre><code class=language-c>uint64
nfreemem()
{
    uint64 cnt = 0;
    struct run *r;
    acquire(&amp;kmem.lock);
    r = kmem.freelist;
    while (r)
    {
        cnt++;
        r = r-&gt;next;
    }
    release(&amp;kmem.lock);
    return cnt * PGSIZE;
}
</code></pre><h3 id=nproc>nproc()</h3><p>在kernel/proc.c中添加统计进程状态不为UNUSED的进程数函数nproc()。</p><pre><code class=language-c>uint64
nproc(void)
{
    uint64 cnt = 0;
    struct proc *p;

    for (p = proc; p &lt; &amp;proc[NPROC]; p++)
    {
        acquire(&amp;p-&gt;lock);
        if (p-&gt;state != UNUSED)
            cnt++;
        release(&amp;p-&gt;lock);
    }
    return cnt;
}
</code></pre><h3 id=sys_sysinfo>sys_sysinfo()</h3><p>在kernel/sysproc.c中添加系统调用入口。</p><pre><code class=language-c>uint64
sys_sysinfo(void)
{
    uint64 addr;
    struct sysinfo info;
    struct proc *p = myproc();

    argaddr(0, &amp;addr);

    info.freemem = nfreemem();
    info.nproc = nproc();

    if (copyout(p-&gt;pagetable, addr, (char *)&amp;info, sizeof(info)) &lt; 0)
        return -1;

    return 0;
}
</code></pre></article><div class=my-4><a href=/tags/mit/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#MIT</a>
<a href=/tags/6.s081/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#6.S081</a>
<a href=/tags/os/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#OS</a></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">上一页</span>
<a href=/posts/blog-migration/ class=block>从Hexo迁移到Hugo</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">下一页</span>
<a href=/posts/start-xv6/ class=block>Starting xv6 and the first process</a></div></div><div id=valine-comments class=mt-4></div><script defer src=https://cdn.jsdelivr.net/npm/valine@1.4.16/dist/Valine.min.js integrity=sha384-e0+DNUCJo75aOAzHQbFWYBCM9/S4f0BhRJXvEgbE3mMS85RM20MSSGStHuNdY2QK crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){new Valine({el:"#valine-comments",appId:"zOEvCRaHczqQkvn7g5bk2d9c-gzGzoHsz",appKey:"JJQvXVH4XIDyjJaIK2HWeTY3"})})</script></div><div class=col-span-2><div class="bg-secondary-bg prose max-w-none rounded p-6"><h3>系列文章</h3><a href=/posts/s6081-lab2/ class=no-underline>MIT6.S081 System Calls</a><br><a href=/posts/start-xv6/ class=no-underline>Starting xv6 and the first process</a><br><a href=/posts/s6081-lab1/ class=no-underline>MIT6.S081 Xv6 and Unix utilities</a><br></div><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>本页内容</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#system-call-tracing>System call tracing</a><ul><li><a href=#注册用户程序trace>注册用户程序trace</a></li><li><a href=#添加系统调用trace函数原型>添加系统调用trace函数原型</a></li><li><a href=#添加ecall入口>添加ecall入口</a></li><li><a href=#设置系统调用的序号>设置系统调用的序号</a></li><li><a href=#为进程添加trace_mask参数>为进程添加trace_mask参数</a></li><li><a href=#实现sys_trace>实现sys_trace()</a></li><li><a href=#修改fork>修改fork()</a></li><li><a href=#修改syscall>修改syscall()</a></li></ul></li><li><a href=#sysinfo>Sysinfo</a><ul><li><a href=#nfreemem>nfreemem()</a></li><li><a href=#nproc>nproc()</a></li><li><a href=#sys_sysinfo>sys_sysinfo()</a></li></ul></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>相关</h3><a href=/posts/start-xv6/ class=no-underline>Starting xv6 and the first process</a><br><a href=/posts/s6081-lab1/ class=no-underline>MIT6.S081 Xv6 and Unix utilities</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2019 - 2023 <a href=https://github.com/Elitedj>Elitedj</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>